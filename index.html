<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberQuell CRM | Lead Management</title>
    <link rel="icon" type="image/png" href="CQ_Icon-Only_Version_Green.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --racing-green: #1E3932;
            --watercourse: #006241;
            --accent-green: #00754A;
            --humming-bird: #D4E9E2;
            --white: #FFFFFF;
            --snow: #F9F9F9;
            --romance: #F2F0EB;
            --text-dark: #000000;
            --text-muted: #6B7280;
            --text-light: #9CA3AF;
            --status-new: #3B82F6;
            --status-contacted: #8B5CF6;
            --status-qualified: #F59E0B;
            --status-negotiation: #EC4899;
            --status-won: #10B981;
            --status-lost: #EF4444;
            --label-urgent: #EF4444;
            --label-high-value: #F59E0B;
            --label-follow-up: #3B82F6;
            --label-hot: #EC4899;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            font-family: 'DM Sans', sans-serif;
            background-color: var(--snow);
            color: var(--text-dark);
            overflow: hidden;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--romance); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--watercourse); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--racing-green); }

        /* Login Page */
        .login-page {
            height: 100vh;
            display: flex;
            background: linear-gradient(135deg, var(--racing-green) 0%, var(--watercourse) 100%);
        }

        .login-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: var(--white);
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .login-logo img {
            width: 60px;
            height: 60px;
        }

        .login-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .login-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-xl);
        }

        .login-card h2 {
            color: var(--racing-green);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .login-card p {
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .google-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            background: var(--white);
            border: 2px solid var(--romance);
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .google-btn:hover {
            border-color: var(--watercourse);
            background: var(--snow);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .google-btn img {
            width: 20px;
            height: 20px;
        }

        .login-features {
            margin-top: 3rem;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            max-width: 500px;
        }

        .login-feature {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .login-feature i {
            font-size: 1.25rem;
            color: var(--humming-bird);
        }

        .login-feature span {
            font-size: 0.9rem;
        }

        .login-page.hidden { display: none; }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.hidden { display: none; }

        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid var(--romance);
            border-top-color: var(--watercourse);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* App Container */
        .app {
            display: none;
            height: 100vh;
            overflow: hidden;
        }

        .app.active {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--racing-green);
            color: var(--white);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: var(--watercourse);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .sidebar-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section { margin-bottom: 1.5rem; }

        .nav-section-title {
            padding: 0.5rem 1.25rem;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.5);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.7rem 1.25rem;
            color: var(--humming-bird);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .nav-item.active {
            background: var(--watercourse);
            color: var(--white);
            border-right: 3px solid var(--accent-green);
        }

        .nav-item i { width: 18px; text-align: center; }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-green);
            color: var(--white);
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-weight: 600;
        }

        /* User Profile in Sidebar */
        .sidebar-user {
            padding: 1rem 1.25rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-green);
        }

        .sidebar-user-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-email {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .logout-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all var(--transition-fast);
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--white);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            background: var(--white);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            padding: 0.625rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .view-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--romance);
            padding: 0.25rem;
            border-radius: 8px;
        }

        .view-tab {
            padding: 0.45rem 0.875rem;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all var(--transition-fast);
        }

        .view-tab:hover { color: var(--racing-green); }

        .view-tab.active {
            background: var(--white);
            color: var(--racing-green);
            box-shadow: var(--shadow-sm);
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--snow);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 0.45rem 0.875rem;
            width: 280px;
        }

        .search-box i { color: var(--text-muted); font-size: 0.85rem; }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            flex: 1;
            font-size: 0.85rem;
        }

        .search-box input::placeholder { color: var(--text-light); }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.875rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-primary {
            background: var(--watercourse);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--racing-green);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--watercourse);
            border: 1px solid var(--watercourse);
        }

        .btn-secondary:hover { background: var(--humming-bird); }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
        }

        .btn-ghost:hover {
            background: var(--snow);
            color: var(--racing-green);
        }

        .btn-danger {
            background: transparent;
            color: var(--label-urgent);
            border: 1px solid var(--label-urgent);
        }

        .btn-danger:hover {
            background: var(--label-urgent);
            color: var(--white);
        }

        .online-users {
            display: flex;
            align-items: center;
            gap: -8px;
        }

        .online-user {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--white);
            margin-left: -8px;
            object-fit: cover;
            background: var(--humming-bird);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--racing-green);
        }

        .online-user:first-child { margin-left: 0; }

        .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background: var(--status-won);
            border: 2px solid var(--white);
            border-radius: 50%;
        }

        /* Filter Bar */
        .filter-bar {
            background: var(--white);
            padding: 0.625rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.875rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .filter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .filter-select {
            padding: 0.35rem 0.6rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 0.8rem;
            background: var(--white);
            cursor: pointer;
            outline: none;
        }

        .filter-select:focus { border-color: var(--watercourse); }

        .lead-count {
            margin-left: auto;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .lead-count strong { color: var(--racing-green); }

        .bulk-actions {
            display: none;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--white);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            margin: 0 1.25rem 0.75rem;
            box-shadow: var(--shadow-sm);
        }

        .bulk-actions.visible { display: flex; }

        .bulk-count {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .bulk-actions select {
            padding: 0.35rem 0.6rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 0.8rem;
            background: var(--white);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Analytics Dashboard */
        .analytics-section {
            padding: 0.875rem 1.25rem;
            background: var(--white);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: none;
        }

        .analytics-section.visible { display: block; }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.75rem;
        }

        .stat-card {
            background: var(--snow);
            border-radius: 8px;
            padding: 0.875rem;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card.new::before { background: var(--status-new); }
        .stat-card.contacted::before { background: var(--status-contacted); }
        .stat-card.qualified::before { background: var(--status-qualified); }
        .stat-card.negotiation::before { background: var(--status-negotiation); }
        .stat-card.won::before { background: var(--status-won); }
        .stat-card.lost::before { background: var(--status-lost); }
        .stat-card.meta::before { background: var(--watercourse); }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.35rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--racing-green);
        }

        .stat-amount {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Kanban Board */
        .kanban-view {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.875rem 1.25rem;
        }

        .kanban-board {
            display: flex;
            gap: 0.75rem;
            height: 100%;
            min-width: max-content;
        }

        .kanban-column {
            width: 280px;
            background: var(--romance);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 280px);
        }

        .column-header {
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid transparent;
        }

        .column-header.new { border-color: var(--status-new); }
        .column-header.contacted { border-color: var(--status-contacted); }
        .column-header.qualified { border-color: var(--status-qualified); }
        .column-header.negotiation { border-color: var(--status-negotiation); }
        .column-header.won { border-color: var(--status-won); }
        .column-header.lost { border-color: var(--status-lost); }

        .column-title {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--racing-green);
        }

        .column-count {
            background: var(--white);
            color: var(--text-muted);
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .column-action-btn {
            width: 26px;
            height: 26px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .column-action-btn:hover {
            background: var(--white);
            color: var(--racing-green);
        }

        .column-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 100px;
        }

        .column-content.drag-over {
            background: rgba(0, 98, 65, 0.1);
        }

        /* Lead Cards */
        .lead-card {
            background: var(--white);
            border-radius: 6px;
            padding: 0.65rem;
            cursor: grab;
            transition: all var(--transition-fast);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .lead-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .lead-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .lead-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.4rem;
            margin-bottom: 0.35rem;
        }

        .lead-id {
            font-size: 0.65rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .lead-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .lead-priority.high { background: var(--label-urgent); }
        .lead-priority.medium { background: var(--label-high-value); }
        .lead-priority.low { background: var(--status-won); }

        .lead-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--racing-green);
            margin-bottom: 0.2rem;
            line-height: 1.3;
        }

        .lead-company {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
        }

        .lead-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
            margin-bottom: 0.4rem;
        }

        .lead-tag {
            font-size: 0.6rem;
            padding: 0.15rem 0.35rem;
            border-radius: 3px;
            font-weight: 500;
        }

        .lead-tag.urgent { background: rgba(239, 68, 68, 0.1); color: var(--label-urgent); }
        .lead-tag.high-value { background: rgba(245, 158, 11, 0.1); color: var(--label-high-value); }
        .lead-tag.follow-up { background: rgba(59, 130, 246, 0.1); color: var(--label-follow-up); }
        .lead-tag.hot { background: rgba(236, 72, 153, 0.1); color: var(--label-hot); }

        .lead-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 0.4rem;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .lead-assignee {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--humming-bird);
            color: var(--racing-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .lead-meta {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.65rem;
            color: var(--text-light);
        }

        .lead-meta span {
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .lead-value {
            font-weight: 600;
            color: var(--watercourse);
        }

        /* List View */
        .list-view {
            flex: 1;
            overflow: auto;
            padding: 0.875rem 1.25rem;
            display: none;
        }

        .list-view.active { display: block; }

        .leads-table {
            width: 100%;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            border-collapse: collapse;
        }

        .leads-table th,
        .leads-table td {
            padding: 0.65rem 0.875rem;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .leads-table th {
            background: var(--snow);
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            cursor: pointer;
            user-select: none;
        }

        .leads-table th:hover { background: var(--romance); }

        .leads-table tbody tr {
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .leads-table tbody tr:hover { background: var(--snow); }

        .table-lead-name {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .table-lead-info { display: flex; flex-direction: column; }

        .table-lead-title {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--racing-green);
        }

        .table-lead-company {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .lead-purpose {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.35rem;
        }

        .table-status {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .table-status.new { background: rgba(59, 130, 246, 0.1); color: var(--status-new); }
        .table-status.contacted { background: rgba(139, 92, 246, 0.1); color: var(--status-contacted); }
        .table-status.qualified { background: rgba(245, 158, 11, 0.1); color: var(--status-qualified); }
        .table-status.negotiation { background: rgba(236, 72, 153, 0.1); color: var(--status-negotiation); }
        .table-status.won { background: rgba(16, 185, 129, 0.1); color: var(--status-won); }
        .table-status.lost { background: rgba(239, 68, 68, 0.1); color: var(--status-lost); }

        .table-value {
            font-weight: 600;
            color: var(--watercourse);
            font-size: 0.85rem;
        }

        .row-select {
            width: 16px;
            height: 16px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.9) translateY(20px);
            transition: transform var(--transition-normal);
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--racing-green);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--snow);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--romance);
            color: var(--racing-green);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
        }

        .modal-section { margin-bottom: 1.25rem; }
        .modal-section:last-child { margin-bottom: 0; }

        .modal-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.6rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.875rem;
        }

        .form-group { margin-bottom: 0.875rem; }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--racing-green);
            margin-bottom: 0.35rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem 0.65rem;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            font-size: 0.85rem;
            font-family: inherit;
            outline: none;
            transition: border-color var(--transition-fast);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--watercourse);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .tag-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .tag-option {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.35rem 0.6rem;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all var(--transition-fast);
        }

        .tag-option:hover { border-color: var(--watercourse); }

        .tag-option.selected {
            background: var(--humming-bird);
            border-color: var(--watercourse);
            color: var(--racing-green);
        }

        .tag-option input { display: none; }

        /* Activity Section */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 0.6rem;
        }

        .activity-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--humming-bird);
            color: var(--racing-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .activity-content { flex: 1; }

        .activity-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.15rem;
        }

        .activity-author {
            font-weight: 500;
            font-size: 0.8rem;
            color: var(--racing-green);
        }

        .activity-time {
            font-size: 0.7rem;
            color: var(--text-light);
        }

        .activity-text {
            font-size: 0.8rem;
            color: var(--text-dark);
            line-height: 1.4;
        }

        .activity-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.15rem 0.4rem;
            background: var(--snow);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-right: 0.3rem;
        }

        .comment-input {
            display: flex;
            gap: 0.6rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            margin-top: 0.75rem;
        }

        .comment-input textarea {
            flex: 1;
            padding: 0.5rem 0.65rem;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: inherit;
            resize: none;
            min-height: 50px;
            outline: none;
        }

        .comment-input textarea:focus { border-color: var(--watercourse); }

        .modal-footer {
            padding: 0.875rem 1.25rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-footer-left,
        .modal-footer-right {
            display: flex;
            gap: 0.4rem;
        }

        /* Team Modal */
        .team-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--snow);
            border-radius: 8px;
        }

        .team-member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .team-member-info { flex: 1; }

        .team-member-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--racing-green);
        }

        .team-member-email {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .team-member-role {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            background: var(--humming-bird);
            color: var(--racing-green);
            border-radius: 4px;
        }

        .team-manage {
            padding: 1rem;
            border: 1px dashed rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            margin-bottom: 1rem;
            background: var(--snow);
        }

        .team-manage.hidden { display: none; }

        .team-form {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .team-form input,
        .team-form select {
            padding: 0.5rem 0.6rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .team-form .btn {
            grid-column: span 3;
            justify-self: start;
        }

        .team-note {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .team-member-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .role-select {
            padding: 0.3rem 0.4rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 0.75rem;
            background: var(--white);
        }

        .btn-small {
            padding: 0.35rem 0.5rem;
            font-size: 0.7rem;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 1.25rem;
            right: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            z-index: 1100;
        }

        .toast {
            background: var(--racing-green);
            color: var(--white);
            padding: 0.65rem 0.875rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            box-shadow: var(--shadow-lg);
            transform: translateX(120%);
            transition: transform var(--transition-normal);
            font-size: 0.85rem;
        }

        .toast.show { transform: translateX(0); }
        .toast.success { background: var(--status-won); }
        .toast.error { background: var(--label-urgent); }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .empty-state p { font-size: 0.8rem; }

        /* Mobile menu button (hidden on desktop) */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--racing-green);
            cursor: pointer;
            padding: 0.4rem 0.5rem;
            border-radius: 6px;
            transition: background var(--transition-fast);
        }
        .mobile-menu-btn:hover { background: var(--snow); }

        /* Sidebar backdrop (hidden by default) */
        .sidebar-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 499;
        }
        .sidebar-backdrop.visible { display: block; }

        /* Responsive */
        @media (max-width: 1024px) {
            .analytics-grid { grid-template-columns: repeat(4, 1fr); }
        }

        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .sidebar-title, .nav-section-title, .nav-item span, .nav-badge,
            .sidebar-user-info { display: none; }
            .nav-item { justify-content: center; padding: 0.75rem; }
            .analytics-grid { grid-template-columns: repeat(2, 1fr); }
            .search-box { display: none; }
            .form-row { grid-template-columns: 1fr; }
            .login-features { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            /* Unlock vertical page scrolling — desktop locks overflow at every level */
            html, body { overflow: auto; }
            .app { height: auto; min-height: 100vh; overflow: visible; }
            .main-content { overflow: visible; }
            .content-area { flex: none; overflow: visible; }

            /* Hamburger visible, sidebar becomes overlay */
            .mobile-menu-btn { display: flex; }
            .sidebar {
                position: fixed;
                top: 0;
                bottom: 0;
                left: -260px;
                width: 260px;
                z-index: 500;
                transition: left 0.25s ease;
            }
            .sidebar.open { left: 0; }
            /* Restore sidebar text labels inside overlay */
            .sidebar-title, .nav-section-title, .nav-item span, .nav-badge,
            .sidebar-user-info { display: block; }
            .nav-item { justify-content: flex-start; padding: 0.7rem 1.25rem; }

            /* Top bar wraps: hamburger + tabs on row 1, search on row 2 */
            .top-bar { flex-wrap: wrap; padding: 0.5rem 0.75rem; gap: 0.4rem; }
            .search-box { display: flex; width: 100%; order: 3; }
            .top-actions { margin-left: auto; }
            .online-users { display: none; }

            /* Filter bar stacks vertically */
            .filter-bar { flex-direction: column; align-items: flex-start; padding: 0.5rem 0.75rem; gap: 0.35rem; }
            .lead-count { margin-left: 0; }

            /* Analytics */
            .analytics-section { padding: 0.5rem 0.75rem; }
            .analytics-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .stat-value { font-size: 1.15rem; }

            /* Kanban — swipe horizontally, columns grow to fit all cards */
            .kanban-view { flex: none; padding: 0.5rem 0.75rem; overflow-x: auto; overflow-y: visible; -webkit-overflow-scrolling: touch; }
            .kanban-board { height: auto; }
            .kanban-column { width: 220px; max-height: none; height: auto; }
            .column-content { flex: none; overflow-y: visible; }

            /* List view — swipe horizontally, rows visible on page scroll */
            .list-view { flex: none; padding: 0.5rem; overflow-x: auto; overflow-y: visible; }
            .leads-table { min-width: 580px; }

            /* Modal — bottom sheet */
            .modal-overlay { align-items: flex-end; }
            .modal {
                width: 100%;
                max-width: 100%;
                max-height: 90vh;
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
            }
            .modal-overlay.active .modal { transform: translateY(0); }

            /* Login page */
            .login-left { padding: 2rem 1rem; }
            .login-card { padding: 1.5rem; }
            .login-title { font-size: 1.8rem; }
            .login-features { margin-top: 1.5rem; gap: 0.6rem; }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lead-card { animation: slideUp 0.3s ease forwards; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loader"></div>
        <div class="loading-text">Loading CyberQuell CRM...</div>
    </div>

    <!-- Login Page -->
    <div class="login-page" id="login-page">
        <div class="login-left">
            <div class="login-logo">
                <img src="CQ_Icon-Only_Version_Green.png" alt="CyberQuell">
            </div>
            <h1 class="login-title">CyberQuell CRM</h1>
            <p class="login-subtitle">Manage your leads, close more deals</p>
            
            <div class="login-card">
                <h2>Welcome</h2>
                <p>Sign in to access your team's CRM dashboard</p>
                <button class="google-btn" id="google-signin-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    Continue with Google
                </button>
            </div>

            <div class="login-features">
                <div class="login-feature">
                    <i class="fas fa-users"></i>
                    <span>Team Collaboration</span>
                </div>
                <div class="login-feature">
                    <i class="fas fa-sync"></i>
                    <span>Real-time Sync</span>
                </div>
                <div class="login-feature">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics Dashboard</span>
                </div>
                <div class="login-feature">
                    <i class="fas fa-shield-alt"></i>
                    <span>Secure & Private</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app" id="app">
        <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="CQ_Icon-Only_Version_Green.png" alt="CyberQuell">
                </div>
                <span class="sidebar-title">CyberQuell</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" data-view="leads">
                        <i class="fas fa-users"></i>
                        <span>All Leads</span>
                        <span class="nav-badge" id="total-leads-badge">0</span>
                    </a>
                    <a class="nav-item" data-filter="my-leads">
                        <i class="fas fa-user-check"></i>
                        <span>My Leads</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Quick Filters</div>
                    <a class="nav-item" data-filter="urgent">
                        <i class="fas fa-fire"></i>
                        <span>Urgent</span>
                    </a>
                    <a class="nav-item" data-filter="high-value">
                        <i class="fas fa-gem"></i>
                        <span>High Value</span>
                    </a>
                    <a class="nav-item" data-filter="follow-up">
                        <i class="fas fa-clock"></i>
                        <span>Follow Up</span>
                    </a>
                    <a class="nav-item" data-filter="hot">
                        <i class="fas fa-star"></i>
                        <span>Hot Leads</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Manage</div>
                    <a class="nav-item" id="team-nav-btn">
                        <i class="fas fa-users-cog"></i>
                        <span>Team</span>
                    </a>
                    <a class="nav-item" id="export-nav-btn">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </a>
                </div>
            </nav>
            <div class="sidebar-user">
                <img class="sidebar-user-avatar" id="user-avatar" src="" alt="">
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="user-name"></div>
                    <div class="sidebar-user-email" id="user-email"></div>
                </div>
                <button class="logout-btn" id="logout-btn" title="Sign out">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <button class="mobile-menu-btn" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                <div class="view-tabs">
                    <button class="view-tab active" data-view-type="kanban">
                        <i class="fas fa-columns"></i> Board
                    </button>
                    <button class="view-tab" data-view-type="list">
                        <i class="fas fa-list"></i> List
                    </button>
                </div>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Search leads...">
                </div>
                <div class="top-actions">
                    <div class="online-users" id="online-users"></div>
                    <button class="btn btn-ghost" id="toggle-analytics" title="Toggle Analytics">
                        <i class="fas fa-chart-pie"></i>
                    </button>
                    <button class="btn btn-primary" id="add-lead-btn">
                        <i class="fas fa-plus"></i> Add Lead
                    </button>
                </div>
            </div>

            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Status:</span>
                    <select class="filter-select" id="filter-status">
                        <option value="">All Stages</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="qualified">Qualified</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="won">Won</option>
                        <option value="lost">Lost</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Assignee:</span>
                    <select class="filter-select" id="filter-assignee">
                        <option value="">All Team</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Priority:</span>
                    <select class="filter-select" id="filter-priority">
                        <option value="">Any</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="lead-count">
                    Showing <strong id="visible-count">0</strong> of <strong id="total-count">0</strong> leads
                </div>
            </div>

            <div class="content-area">
                <div class="analytics-section visible" id="analytics-section">
                    <div class="analytics-grid">
                        <div class="stat-card new">
                            <div class="stat-label">New</div>
                            <div class="stat-value" id="stat-new">0</div>
                            <div class="stat-amount" id="stat-new-amount">$0</div>
                        </div>
                        <div class="stat-card contacted">
                            <div class="stat-label">Contacted</div>
                            <div class="stat-value" id="stat-contacted">0</div>
                            <div class="stat-amount" id="stat-contacted-amount">$0</div>
                        </div>
                        <div class="stat-card qualified">
                            <div class="stat-label">Qualified</div>
                            <div class="stat-value" id="stat-qualified">0</div>
                            <div class="stat-amount" id="stat-qualified-amount">$0</div>
                        </div>
                        <div class="stat-card negotiation">
                            <div class="stat-label">Negotiation</div>
                            <div class="stat-value" id="stat-negotiation">0</div>
                            <div class="stat-amount" id="stat-negotiation-amount">$0</div>
                        </div>
                        <div class="stat-card won">
                            <div class="stat-label">Won</div>
                            <div class="stat-value" id="stat-won">0</div>
                            <div class="stat-amount" id="stat-won-amount">$0</div>
                        </div>
                        <div class="stat-card lost">
                            <div class="stat-label">Lost</div>
                            <div class="stat-value" id="stat-lost">0</div>
                            <div class="stat-amount" id="stat-lost-amount">$0</div>
                        </div>
                        <div class="stat-card meta">
                            <div class="stat-label">Conversion</div>
                            <div class="stat-value" id="stat-conversion">0%</div>
                            <div class="stat-amount" id="stat-conversion-sub">Win rate</div>
                        </div>
                        <div class="stat-card meta">
                            <div class="stat-label">Avg Time in Stage</div>
                            <div class="stat-value" id="stat-avg-stage">0d</div>
                            <div class="stat-amount" id="stat-avg-stage-sub">All leads</div>
                        </div>
                    </div>
                </div>

                <div class="kanban-view" id="kanban-view">
                    <div class="kanban-board" id="kanban-board"></div>
                </div>

                <div class="list-view" id="list-view">
                    <div class="bulk-actions" id="bulk-actions">
                        <span class="bulk-count" id="bulk-count">0 selected</span>
                        <select id="bulk-status">
                            <option value="">Change status...</option>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="won">Won</option>
                            <option value="lost">Lost</option>
                        </select>
                        <button class="btn btn-primary" type="button" id="bulk-apply-btn">
                            <i class="fas fa-layer-group"></i> Apply
                        </button>
                    </div>
                    <table class="leads-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="row-select" id="select-all">
                                </th>
                                <th data-sort="name">Lead <i class="fas fa-sort"></i></th>
                                <th>Lead For</th>
                                <th data-sort="status">Status <i class="fas fa-sort"></i></th>
                                <th data-sort="value">Value <i class="fas fa-sort"></i></th>
                                <th>Tags</th>
                                <th data-sort="assignee">Assignee <i class="fas fa-sort"></i></th>
                                <th>First Follow-up</th>
                                <th data-sort="created">Created <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Lead Modal -->
    <div class="modal-overlay" id="lead-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Add New Lead</h2>
                <button class="modal-close" id="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="lead-form">
                    <input type="hidden" id="lead-id">
                    <div class="modal-section">
                        <h3 class="modal-section-title">Basic Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lead-name">Lead Name *</label>
                                <input type="text" id="lead-name" required placeholder="e.g., Enterprise Security Deal">
                            </div>
                            <div class="form-group">
                                <label for="lead-company">Company</label>
                                <input type="text" id="lead-company" placeholder="e.g., Acme Corporation">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lead-email">Email</label>
                                <input type="email" id="lead-email" placeholder="e.g., contact@acme.com">
                            </div>
                            <div class="form-group">
                                <label for="lead-phone">Phone</label>
                                <input type="tel" id="lead-phone" placeholder="e.g., +1 (555) 123-4567">
                            </div>
                        </div>
                    </div>
                    <div class="modal-section">
                        <h3 class="modal-section-title">Lead Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lead-status">Status</label>
                                <select id="lead-status">
                                    <option value="new">New</option>
                                    <option value="contacted">Contacted</option>
                                    <option value="qualified">Qualified</option>
                                    <option value="negotiation">Negotiation</option>
                                    <option value="won">Won</option>
                                    <option value="lost">Lost</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="lead-priority">Priority</label>
                                <select id="lead-priority">
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lead-value">Estimated Value ($)</label>
                                <input type="number" id="lead-value" placeholder="e.g., 50000" min="0">
                            </div>
                            <div class="form-group">
                                <label for="lead-assignee">Assignee</label>
                                <select id="lead-assignee"></select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lead-purpose">What is this lead for?</label>
                                <input type="text" id="lead-purpose" placeholder="e.g., MDR renewal, SOC buildout">
                            </div>
                            <div class="form-group">
                                <label for="lead-first-followup">First Follow-up Sent</label>
                                <input type="date" id="lead-first-followup">
                            </div>
                        </div>
                    </div>
                    <div class="modal-section">
                        <h3 class="modal-section-title">Tags</h3>
                        <div class="tag-selector" id="tag-selector">
                            <label class="tag-option" data-tag="urgent">
                                <input type="checkbox" name="tags" value="urgent">
                                <i class="fas fa-fire"></i> Urgent
                            </label>
                            <label class="tag-option" data-tag="high-value">
                                <input type="checkbox" name="tags" value="high-value">
                                <i class="fas fa-gem"></i> High Value
                            </label>
                            <label class="tag-option" data-tag="follow-up">
                                <input type="checkbox" name="tags" value="follow-up">
                                <i class="fas fa-clock"></i> Follow Up
                            </label>
                            <label class="tag-option" data-tag="hot">
                                <input type="checkbox" name="tags" value="hot">
                                <i class="fas fa-star"></i> Hot
                            </label>
                        </div>
                    </div>
                    <div class="modal-section">
                        <h3 class="modal-section-title">Notes</h3>
                        <div class="form-group">
                            <textarea id="lead-notes" placeholder="Add any additional notes..."></textarea>
                        </div>
                    </div>
                    <div class="modal-section" id="activity-section" style="display: none;">
                        <h3 class="modal-section-title">Activity & Comments</h3>
                        <div class="activity-list" id="activity-list"></div>
                        <div class="comment-input">
                            <img class="activity-avatar" id="comment-avatar" src="" alt="">
                            <textarea id="new-comment" placeholder="Add a comment..."></textarea>
                            <button type="button" class="btn btn-primary" id="add-comment-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button type="button" class="btn btn-danger" id="delete-lead-btn" style="display: none;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
                <div class="modal-footer-right">
                    <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
                    <button type="submit" form="lead-form" class="btn btn-primary" id="save-lead-btn">
                        <i class="fas fa-check"></i> Save Lead
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Modal -->
    <div class="modal-overlay" id="team-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Team Members</h2>
                <button class="modal-close" id="team-modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="team-manage hidden" id="team-manage">
                    <h3 class="modal-section-title">Manage Team</h3>
                    <div class="team-form">
                        <input type="text" id="team-name" placeholder="Full name">
                        <input type="email" id="team-email" placeholder="Email address">
                        <select id="team-role">
                            <option value="member">Member</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button type="button" class="btn btn-primary" id="add-team-btn">
                            <i class="fas fa-user-plus"></i> Add Member
                        </button>
                    </div>
                    <div class="team-note">Added members appear in assignee lists. Actual access still depends on Firebase Auth.</div>
                </div>
                <div class="team-list" id="team-list"></div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left"></div>
                <div class="modal-footer-right">
                    <button type="button" class="btn btn-secondary" id="team-close-btn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Column definitions
        const COLUMNS = [
            { id: 'new', label: 'New' },
            { id: 'contacted', label: 'Contacted' },
            { id: 'qualified', label: 'Qualified' },
            { id: 'negotiation', label: 'Negotiation' },
            { id: 'won', label: 'Won' },
            { id: 'lost', label: 'Lost' }
        ];

        // State
        let currentUser = null;
        let currentUserRole = 'member';
        let leads = [];
        let teamMembers = [];
        let currentFilter = {};
        let currentView = 'kanban';
        let editingLeadId = null;
        let unsubscribeLeads = null;
        let unsubscribeTeam = null;
        let heartbeatInterval = null;
        let lastRenderedLeadIds = [];
        const selectedLeadIds = new Set();

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginPage = document.getElementById('login-page');
        const app = document.getElementById('app');
        const kanbanBoard = document.getElementById('kanban-board');
        const kanbanView = document.getElementById('kanban-view');
        const listView = document.getElementById('list-view');
        const leadsTableBody = document.getElementById('leads-table-body');
        const leadModal = document.getElementById('lead-modal');
        const teamModal = document.getElementById('team-modal');
        const leadForm = document.getElementById('lead-form');
        const searchInput = document.getElementById('search-input');
        const analyticsSection = document.getElementById('analytics-section');

        // =====================================
        // Utility Functions
        // =====================================

        function escapeHTML(value) {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function toDate(value) {
            if (!value) return null;
            if (value.toDate) return value.toDate();
            if (value instanceof Date) return value;
            if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
                return new Date(`${value}T00:00:00`);
            }
            if (typeof value === 'string' || typeof value === 'number') return new Date(value);
            return null;
        }

        function formatCurrency(amount) {
            if (!amount) return '$0';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(timestamp) {
            const date = toDate(timestamp);
            if (!date || Number.isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function getTimeAgo(timestamp) {
            const date = toDate(timestamp);
            if (!date) return 'Just now';
            const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
            const intervals = [
                { label: 'year', seconds: 31536000 },
                { label: 'month', seconds: 2592000 },
                { label: 'week', seconds: 604800 },
                { label: 'day', seconds: 86400 },
                { label: 'hour', seconds: 3600 },
                { label: 'minute', seconds: 60 }
            ];
            for (const interval of intervals) {
                const count = Math.floor(seconds / interval.seconds);
                if (count >= 1) return `${count} ${interval.label}${count > 1 ? 's' : ''} ago`;
            }
            return 'Just now';
        }

        function getTimestampValue(value) {
            const date = toDate(value);
            return date ? date.getTime() : 0;
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function getTeamMember(id) {
            return teamMembers.find(m => m.id === id) || { name: 'Unassigned', photoURL: null };
        }

        function isManagerOrAdmin() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canEditLead(lead) {
            if (!lead || isManagerOrAdmin()) return true;
            return lead.assignee === currentUser?.uid;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateBulkActionsVisibility() {
            const bulk = document.getElementById('bulk-actions');
            if (!bulk) return;
            bulk.classList.toggle('visible', isManagerOrAdmin());
        }

        function updateTeamManagementVisibility() {
            const manage = document.getElementById('team-manage');
            if (!manage) return;
            manage.classList.toggle('hidden', !isManagerOrAdmin());
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // =====================================
        // Authentication
        // =====================================

        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                if (error.code === 'auth/popup-blocked') {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithRedirect(provider);
                } else {
                    console.error('Sign in error:', error);
                    showToast('Failed to sign in. Please try again.', 'error');
                }
            }
        });

        // Silently handle any pending redirect result on page load
        auth.getRedirectResult().catch(() => {});

        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                if (unsubscribeLeads) unsubscribeLeads();
                if (unsubscribeTeam) unsubscribeTeam();
                if (heartbeatInterval) clearInterval(heartbeatInterval);
                await auth.signOut();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        });

        auth.onAuthStateChanged(async (user) => {
            try {
                if (user) {
                    currentUser = user;
                    await initializeUser(user);
                    showApp();
                    setupRealtimeListeners();
                } else {
                    currentUser = null;
                    currentUserRole = 'member';
                    if (heartbeatInterval) clearInterval(heartbeatInterval);
                    showLogin();
                }
            } catch (error) {
                console.error('Auth state error:', error);
                showToast('Something went wrong. Please try again.', 'error');
                showLogin();
            }
        });

        async function initializeUser(user) {
            const userRef = db.collection('users').doc(user.uid);
            const userDoc = await userRef.get();
            
            if (!userDoc.exists) {
                await userRef.set({
                    name: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    role: 'member',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
                currentUserRole = 'member';
            } else {
                currentUserRole = userDoc.data().role || 'member';
                await userRef.update({
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        async function updateLastSeen() {
            if (!currentUser) return;
            const userRef = db.collection('users').doc(currentUser.uid);
            await userRef.update({
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            updateLastSeen();
            heartbeatInterval = setInterval(updateLastSeen, 60 * 1000);
        }

        function showLogin() {
            loadingOverlay.classList.add('hidden');
            loginPage.classList.remove('hidden');
            app.classList.remove('active');
        }

        function showApp() {
            loadingOverlay.classList.add('hidden');
            loginPage.classList.add('hidden');
            app.classList.add('active');
            startHeartbeat();
            updateBulkActionsVisibility();
            updateTeamManagementVisibility();

            // Update user info in sidebar
            document.getElementById('user-avatar').src = currentUser.photoURL || '';
            document.getElementById('user-name').textContent = currentUser.displayName;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('comment-avatar').src = currentUser.photoURL || '';
        }

        // =====================================
        // Real-time Data Listeners
        // =====================================

        function setupRealtimeListeners() {
            // Listen to leads collection
            unsubscribeLeads = db.collection('leads')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    leads = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderView();
                }, (error) => {
                    console.error('Leads listener error:', error);
                    showToast('Error loading leads', 'error');
                });

            // Listen to team members
            unsubscribeTeam = db.collection('users')
                .onSnapshot((snapshot) => {
                    teamMembers = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    const self = teamMembers.find(m => m.id === currentUser?.uid);
                    if (self?.role && self.role !== currentUserRole) {
                        currentUserRole = self.role;
                        updateBulkActionsVisibility();
                        updateTeamManagementVisibility();
                    }
                    updateAssigneeDropdowns();
                    updateOnlineUsers();
                }, (error) => {
                    console.error('Team listener error:', error);
                });
        }

        function updateAssigneeDropdowns() {
            const dropdowns = [
                document.getElementById('lead-assignee'),
                document.getElementById('filter-assignee')
            ];

            dropdowns.forEach((select, index) => {
                const currentValue = select.value;
                select.innerHTML = index === 1 ? '<option value="">All Team</option>' : '';
                
                teamMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    if (index === 0 && member.id === currentUser?.uid) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                if (currentValue) select.value = currentValue;
            });
        }

        function updateOnlineUsers() {
            const container = document.getElementById('online-users');
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
            
            const onlineMembers = teamMembers.filter(m => {
                if (!m.lastSeen) return false;
                const lastSeen = m.lastSeen.toDate ? m.lastSeen.toDate() : new Date(m.lastSeen);
                return lastSeen > fiveMinutesAgo;
            }).slice(0, 4);

            container.innerHTML = onlineMembers.map(member => `
                <div class="online-user" title="${escapeHTML(member.name)} (online)" style="position: relative;">
                    ${member.photoURL 
                        ? `<img src="${member.photoURL}" alt="${escapeHTML(member.name)}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`
                        : escapeHTML(getInitials(member.name))
                    }
                    <span class="online-indicator"></span>
                </div>
            `).join('');
        }

        // =====================================
        // Lead CRUD Operations
        // =====================================

        async function saveLead(leadData) {
            try {
                if (leadData.id) {
                    const existing = leads.find(l => l.id === leadData.id);
                    if (!canEditLead(existing)) {
                        showToast('You do not have permission to edit this lead', 'error');
                        return;
                    }
                }
                if (leadData.id) {
                    // Update existing lead
                    await db.collection('leads').doc(leadData.id).update({
                        ...leadData,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.uid
                    });
                    showToast('Lead updated successfully', 'success');
                } else {
                    // Create new lead
                    delete leadData.id;
                    await db.collection('leads').add({
                        ...leadData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.uid,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Lead created successfully', 'success');
                }
            } catch (error) {
                console.error('Save lead error:', error);
                showToast('Failed to save lead', 'error');
            }
        }

        async function deleteLead(leadId) {
            try {
                if (!isManagerOrAdmin()) {
                    showToast('Only managers or admins can delete leads', 'error');
                    return;
                }
                await db.collection('leads').doc(leadId).delete();
                showToast('Lead deleted', 'success');
            } catch (error) {
                console.error('Delete lead error:', error);
                showToast('Failed to delete lead', 'error');
            }
        }

        async function updateLeadStatus(leadId, newStatus) {
            try {
                const lead = leads.find(l => l.id === leadId);
                if (!canEditLead(lead)) {
                    showToast('You do not have permission to update this lead', 'error');
                    return;
                }
                const oldStatus = lead?.status || 'unknown';

                await db.collection('leads').doc(leadId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid,
                    activities: firebase.firestore.FieldValue.arrayUnion({
                        type: 'status',
                        text: `Moved from ${oldStatus} to ${newStatus}`,
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        userPhoto: currentUser.photoURL,
                        timestamp: new Date()
                    })
                });
                showToast(`Lead moved to ${newStatus}`, 'success');
            } catch (error) {
                console.error('Update status error:', error);
                showToast('Failed to update lead', 'error');
            }
        }

        async function addComment(leadId, text) {
            try {
                const lead = leads.find(l => l.id === leadId);
                if (!canEditLead(lead)) {
                    showToast('You do not have permission to comment on this lead', 'error');
                    return;
                }
                await db.collection('leads').doc(leadId).update({
                    activities: firebase.firestore.FieldValue.arrayUnion({
                        type: 'comment',
                        text: text,
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        userPhoto: currentUser.photoURL,
                        timestamp: new Date()
                    }),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('Comment added', 'success');
            } catch (error) {
                console.error('Add comment error:', error);
                showToast('Failed to add comment', 'error');
            }
        }

        // =====================================
        // Filtering
        // =====================================

        function getFilteredLeads() {
            let filtered = [...leads];

            // Search filter
            const search = searchInput.value.toLowerCase().trim();
            if (search) {
                filtered = filtered.filter(lead =>
                    (lead.name && lead.name.toLowerCase().includes(search)) ||
                    (lead.company && lead.company.toLowerCase().includes(search)) ||
                    (lead.email && lead.email.toLowerCase().includes(search)) ||
                    (lead.leadPurpose && lead.leadPurpose.toLowerCase().includes(search))
                );
            }

            // Status filter
            const statusFilter = document.getElementById('filter-status').value;
            if (statusFilter) {
                filtered = filtered.filter(lead => lead.status === statusFilter);
            }

            // Assignee filter
            const assigneeFilter = document.getElementById('filter-assignee').value;
            if (assigneeFilter) {
                filtered = filtered.filter(lead => lead.assignee === assigneeFilter);
            }

            // Priority filter
            const priorityFilter = document.getElementById('filter-priority').value;
            if (priorityFilter) {
                filtered = filtered.filter(lead => lead.priority === priorityFilter);
            }

            // Quick filters
            if (currentFilter.tag) {
                filtered = filtered.filter(lead => lead.tags && lead.tags.includes(currentFilter.tag));
            }

            if (currentFilter.myLeads) {
                filtered = filtered.filter(lead => lead.assignee === currentUser.uid);
            }

            return filtered;
        }

        // =====================================
        // Rendering
        // =====================================

        function renderView() {
            if (currentView === 'kanban') {
                kanbanView.style.display = 'block';
                listView.classList.remove('active');
                renderKanbanBoard();
            } else {
                kanbanView.style.display = 'none';
                listView.classList.add('active');
                renderListView();
            }
            updateStats();
        }

        function renderKanbanBoard() {
            kanbanBoard.innerHTML = '';
            const filteredLeads = getFilteredLeads();

            COLUMNS.forEach(column => {
                const columnLeads = filteredLeads.filter(lead => lead.status === column.id);
                
                const columnEl = document.createElement('div');
                columnEl.className = 'kanban-column';
                columnEl.dataset.columnId = column.id;

                columnEl.innerHTML = `
                    <div class="column-header ${column.id}">
                        <div class="column-title">
                            ${column.label}
                            <span class="column-count">${columnLeads.length}</span>
                        </div>
                        <button class="column-action-btn" onclick="addLeadToColumn('${column.id}')" title="Add lead">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="column-content" data-column="${column.id}">
                        ${columnLeads.length === 0 
                            ? '<div class="empty-state"><i class="fas fa-inbox"></i><p>No leads</p></div>'
                            : columnLeads.map(lead => renderLeadCard(lead)).join('')
                        }
                    </div>
                `;

                kanbanBoard.appendChild(columnEl);
            });

            setupDragAndDrop();
            updateCounts(filteredLeads);
        }

        function renderLeadCard(lead) {
            const assignee = getTeamMember(lead.assignee);
            const tagsHtml = lead.tags?.length 
                ? lead.tags.map(tag => `<span class="lead-tag ${tag}">${escapeHTML(tag.replace('-', ' '))}</span>`).join('')
                : '';
            const safeName = escapeHTML(lead.name || 'Untitled');
            const safeCompany = escapeHTML(lead.company || '');
            const safePurpose = escapeHTML(lead.leadPurpose || '');

            return `
                <div class="lead-card" draggable="true" data-lead-id="${lead.id}">
                    <div class="lead-card-header">
                        <span class="lead-id">#${lead.id.slice(-6).toUpperCase()}</span>
                        <span class="lead-priority ${lead.priority || 'medium'}"></span>
                    </div>
                    <div class="lead-title">${safeName}</div>
                    ${safeCompany ? `<div class="lead-company">${safeCompany}</div>` : ''}
                    ${safePurpose ? `<div class="lead-purpose">For: ${safePurpose}</div>` : ''}
                    ${tagsHtml ? `<div class="lead-tags">${tagsHtml}</div>` : ''}
                    <div class="lead-footer">
                        <div class="lead-assignee" title="${escapeHTML(assignee.name)}">
                            ${assignee.photoURL 
                                ? `<img src="${assignee.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`
                                : escapeHTML(getInitials(assignee.name))
                            }
                        </div>
                        <div class="lead-meta">
                            ${lead.value ? `<span class="lead-value">${formatCurrency(lead.value)}</span>` : ''}
                            <span><i class="fas fa-comment"></i> ${lead.activities?.length || 0}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderListView() {
            const filteredLeads = getFilteredLeads();

            lastRenderedLeadIds = filteredLeads.map(lead => lead.id);
            selectedLeadIds.forEach(id => {
                if (!lastRenderedLeadIds.includes(id)) selectedLeadIds.delete(id);
            });

            leadsTableBody.innerHTML = filteredLeads.map(lead => {
                const assignee = getTeamMember(lead.assignee);
                const tagsHtml = lead.tags?.length 
                    ? lead.tags.map(tag => `<span class="lead-tag ${tag}">${escapeHTML(tag.replace('-', ' '))}</span>`).join('')
                    : '-';
                const safeName = escapeHTML(lead.name || 'Untitled');
                const safeCompany = escapeHTML(lead.company || '-');
                const safePurpose = escapeHTML(lead.leadPurpose || '-');

                return `
                    <tr data-lead-id="${lead.id}">
                        <td>
                            <input type="checkbox" class="row-select" data-lead-id="${lead.id}" ${selectedLeadIds.has(lead.id) ? 'checked' : ''} ${!isManagerOrAdmin() ? 'disabled' : ''}>
                        </td>
                        <td>
                            <div class="table-lead-name">
                                <span class="lead-priority ${lead.priority || 'medium'}"></span>
                                <div class="table-lead-info">
                                    <span class="table-lead-title">${safeName}</span>
                                    <span class="table-lead-company">${safeCompany}</span>
                                </div>
                            </div>
                        </td>
                        <td>${safePurpose}</td>
                        <td><span class="table-status ${lead.status}">${lead.status}</span></td>
                        <td class="table-value">${formatCurrency(lead.value)}</td>
                        <td>${tagsHtml}</td>
                        <td>
                            <div class="lead-assignee" title="${escapeHTML(assignee.name)}">
                                ${assignee.photoURL 
                                    ? `<img src="${assignee.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`
                                    : escapeHTML(getInitials(assignee.name))
                                }
                            </div>
                        </td>
                        <td>${formatDate(lead.firstFollowup)}</td>
                        <td>${formatDate(lead.createdAt)}</td>
                    </tr>
                `;
            }).join('');

            leadsTableBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (e.target.closest('.row-select')) return;
                    openLeadModal(row.dataset.leadId);
                });
            });

            leadsTableBody.querySelectorAll('.row-select').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.leadId;
                    if (e.target.checked) selectedLeadIds.add(id);
                    else selectedLeadIds.delete(id);
                    updateBulkSelection();
                });
            });

            updateBulkSelection();

            updateCounts(filteredLeads);
        }

        function updateBulkSelection() {
            const bulkCount = document.getElementById('bulk-count');
            const selectAll = document.getElementById('select-all');
            const bulkStatus = document.getElementById('bulk-status');
            const bulkApply = document.getElementById('bulk-apply-btn');

            if (bulkCount) bulkCount.textContent = `${selectedLeadIds.size} selected`;
            if (selectAll) {
                const totalVisible = lastRenderedLeadIds.length;
                const selectedVisible = lastRenderedLeadIds.filter(id => selectedLeadIds.has(id)).length;
                selectAll.checked = totalVisible > 0 && selectedVisible === totalVisible;
                selectAll.indeterminate = selectedVisible > 0 && selectedVisible < totalVisible;
                selectAll.disabled = !isManagerOrAdmin();
            }

            const canBulk = isManagerOrAdmin() && selectedLeadIds.size > 0;
            if (bulkStatus) bulkStatus.disabled = !canBulk;
            if (bulkApply) bulkApply.disabled = !canBulk;
        }

        async function applyBulkStatus() {
            const bulkStatus = document.getElementById('bulk-status');
            const newStatus = bulkStatus?.value;
            if (!isManagerOrAdmin()) {
                showToast('Only managers or admins can run bulk actions', 'error');
                return;
            }
            if (!newStatus) {
                showToast('Pick a status to apply', 'error');
                return;
            }
            if (selectedLeadIds.size === 0) return;

            const batch = db.batch();
            selectedLeadIds.forEach(id => {
                const lead = leads.find(l => l.id === id);
                const oldStatus = lead?.status || 'unknown';
                const ref = db.collection('leads').doc(id);
                batch.update(ref, {
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid,
                    activities: firebase.firestore.FieldValue.arrayUnion({
                        type: 'status',
                        text: `Moved from ${oldStatus} to ${newStatus}`,
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        userPhoto: currentUser.photoURL,
                        timestamp: new Date()
                    })
                });
            });

            try {
                await batch.commit();
                showToast('Bulk status updated', 'success');
                selectedLeadIds.clear();
                if (bulkStatus) bulkStatus.value = '';
                updateBulkSelection();
            } catch (error) {
                console.error('Bulk update error:', error);
                showToast('Bulk update failed', 'error');
            }
        }

        function updateCounts(filteredLeads) {
            document.getElementById('visible-count').textContent = filteredLeads.length;
            document.getElementById('total-count').textContent = leads.length;
            document.getElementById('total-leads-badge').textContent = leads.length;
        }

        function updateStats() {
            COLUMNS.forEach(column => {
                const columnLeads = leads.filter(l => l.status === column.id);
                const count = columnLeads.length;
                const totalValue = columnLeads.reduce((sum, l) => sum + (l.value || 0), 0);
                
                const countEl = document.getElementById(`stat-${column.id}`);
                const amountEl = document.getElementById(`stat-${column.id}-amount`);
                
                if (countEl) countEl.textContent = count;
                if (amountEl) amountEl.textContent = formatCurrency(totalValue);
            });

            const total = leads.length || 1;
            const wonCount = leads.filter(l => l.status === 'won').length;
            const conversionRate = Math.round((wonCount / total) * 100);
            const conversionEl = document.getElementById('stat-conversion');
            if (conversionEl) conversionEl.textContent = `${conversionRate}%`;

            const avgStageEl = document.getElementById('stat-avg-stage');
            if (avgStageEl) {
                const now = Date.now();
                const stageTimes = leads.map(lead => {
                    const statusActivities = (lead.activities || []).filter(a => a.type === 'status');
                    const latestStatus = statusActivities.sort((a, b) => getTimestampValue(b.timestamp) - getTimestampValue(a.timestamp))[0];
                    const startTime = getTimestampValue(latestStatus?.timestamp) || getTimestampValue(lead.createdAt) || now;
                    return Math.max(0, now - startTime);
                });
                const avgMs = stageTimes.length ? stageTimes.reduce((a, b) => a + b, 0) / stageTimes.length : 0;
                const avgDays = Math.max(0, Math.round(avgMs / (1000 * 60 * 60 * 24)));
                avgStageEl.textContent = `${avgDays}d`;
            }
        }

        // =====================================
        // Drag and Drop
        // =====================================

        let draggedCard = null;

        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.lead-card');
            const columns = document.querySelectorAll('.column-content');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    const lead = leads.find(l => l.id === card.dataset.leadId);
                    if (!canEditLead(lead)) {
                        e.preventDefault();
                        showToast('You do not have permission to move this lead', 'error');
                        return;
                    }
                    draggedCard = card;
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    draggedCard = null;
                });
                card.addEventListener('click', () => openLeadModal(card.dataset.leadId));
            });

            columns.forEach(column => {
                column.addEventListener('dragover', (e) => e.preventDefault());
                column.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });
                column.addEventListener('dragleave', () => column.classList.remove('drag-over'));
                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    if (draggedCard) {
                        const leadId = draggedCard.dataset.leadId;
                        const newStatus = column.dataset.column;
                        const lead = leads.find(l => l.id === leadId);
                        
                        if (lead && lead.status !== newStatus) {
                            updateLeadStatus(leadId, newStatus);
                        }
                    }
                });
            });
        }

        // =====================================
        // Modal Functions
        // =====================================

        function openLeadModal(leadId = null) {
            editingLeadId = leadId;
            const lead = leadId ? leads.find(l => l.id === leadId) : null;

            document.getElementById('modal-title').textContent = lead ? 'Edit Lead' : 'Add New Lead';
            document.getElementById('activity-section').style.display = lead ? 'block' : 'none';

            // Populate form
            document.getElementById('lead-id').value = lead?.id || '';
            document.getElementById('lead-name').value = lead?.name || '';
            document.getElementById('lead-company').value = lead?.company || '';
            document.getElementById('lead-email').value = lead?.email || '';
            document.getElementById('lead-phone').value = lead?.phone || '';
            document.getElementById('lead-status').value = lead?.status || 'new';
            document.getElementById('lead-priority').value = lead?.priority || 'medium';
            document.getElementById('lead-value').value = lead?.value || '';
            document.getElementById('lead-assignee').value = lead?.assignee || currentUser.uid;
            document.getElementById('lead-purpose').value = lead?.leadPurpose || '';
            document.getElementById('lead-first-followup').value = lead?.firstFollowup || '';
            document.getElementById('lead-notes').value = lead?.notes || '';

            // Tags
            document.querySelectorAll('.tag-option').forEach(option => {
                const checkbox = option.querySelector('input');
                const isSelected = lead?.tags?.includes(checkbox.value);
                checkbox.checked = isSelected;
                option.classList.toggle('selected', isSelected);
            });

            // Activities
            if (lead?.activities) {
                renderActivities(lead.activities);
            }

            const canEdit = !lead || canEditLead(lead);
            setFormReadOnly(!canEdit);
            document.getElementById('delete-lead-btn').style.display = lead && isManagerOrAdmin() ? 'flex' : 'none';

            leadModal.classList.add('active');
        }

        function setFormReadOnly(readOnly) {
            const fields = leadForm.querySelectorAll('input, select, textarea');
            fields.forEach(field => {
                if (field.id === 'lead-id') return;
                field.disabled = readOnly;
            });
            document.getElementById('save-lead-btn').style.display = readOnly ? 'none' : 'inline-flex';
            const commentInput = document.getElementById('new-comment');
            const addCommentBtn = document.getElementById('add-comment-btn');
            if (commentInput) commentInput.disabled = readOnly;
            if (addCommentBtn) addCommentBtn.disabled = readOnly;
        }

        function closeLeadModal() {
            leadModal.classList.remove('active');
            editingLeadId = null;
            leadForm.reset();
            setFormReadOnly(false);
        }

        function renderActivities(activities) {
            const list = document.getElementById('activity-list');
            const sortedActivities = [...activities].sort((a, b) => 
                getTimestampValue(b.timestamp) - getTimestampValue(a.timestamp)
            );

            list.innerHTML = sortedActivities.map(activity => `
                <div class="activity-item">
                    <div class="activity-avatar">
                        ${activity.userPhoto 
                            ? `<img src="${activity.userPhoto}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`
                            : escapeHTML(getInitials(activity.userName))
                        }
                    </div>
                    <div class="activity-content">
                        <div class="activity-header">
                            <span class="activity-author">${escapeHTML(activity.userName || 'Unknown')}</span>
                            <span class="activity-time">${getTimeAgo(activity.timestamp)}</span>
                        </div>
                        <div class="activity-text">
                            <span class="activity-badge">
                                <i class="fas fa-${activity.type === 'comment' ? 'comment' : activity.type === 'status' ? 'exchange-alt' : 'plus'}"></i>
                                ${escapeHTML(activity.type)}
                            </span>
                            ${escapeHTML(activity.text)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addLeadToColumn(status) {
            openLeadModal();
            document.getElementById('lead-status').value = status;
        }

        // Make function global for onclick
        window.addLeadToColumn = addLeadToColumn;

        // =====================================
        // Event Listeners
        // =====================================

        // Lead form submission
        leadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const leadData = {
                id: editingLeadId || null,
                name: document.getElementById('lead-name').value.trim(),
                company: document.getElementById('lead-company').value.trim(),
                email: document.getElementById('lead-email').value.trim(),
                phone: document.getElementById('lead-phone').value.trim(),
                status: document.getElementById('lead-status').value,
                priority: document.getElementById('lead-priority').value,
                value: parseInt(document.getElementById('lead-value').value) || 0,
                assignee: document.getElementById('lead-assignee').value,
                leadPurpose: document.getElementById('lead-purpose').value.trim(),
                firstFollowup: document.getElementById('lead-first-followup').value || null,
                notes: document.getElementById('lead-notes').value.trim(),
                tags: Array.from(document.querySelectorAll('.tag-option input:checked')).map(cb => cb.value),
                activities: editingLeadId 
                    ? leads.find(l => l.id === editingLeadId)?.activities || []
                    : [{
                        type: 'created',
                        text: 'Lead created',
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        userPhoto: currentUser.photoURL,
                        timestamp: new Date()
                    }]
            };

            await saveLead(leadData);
            closeLeadModal();
        });

        // Delete lead
        document.getElementById('delete-lead-btn').addEventListener('click', async () => {
            if (editingLeadId && confirm('Are you sure you want to delete this lead?')) {
                await deleteLead(editingLeadId);
                closeLeadModal();
            }
        });

        // Add comment
        document.getElementById('add-comment-btn').addEventListener('click', async () => {
            const text = document.getElementById('new-comment').value.trim();
            if (text && editingLeadId) {
                await addComment(editingLeadId, text);
                document.getElementById('new-comment').value = '';
                
                // Refresh activities
                const lead = leads.find(l => l.id === editingLeadId);
                if (lead?.activities) {
                    renderActivities(lead.activities);
                }
            }
        });

        // Modal controls
        document.getElementById('modal-close').addEventListener('click', closeLeadModal);
        document.getElementById('cancel-btn').addEventListener('click', closeLeadModal);
        document.getElementById('add-lead-btn').addEventListener('click', () => openLeadModal());
        leadModal.addEventListener('click', (e) => { if (e.target === leadModal) closeLeadModal(); });

        // View tabs
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentView = this.dataset.viewType;
                renderView();
            });
        });

        // Search
        searchInput.addEventListener('input', debounce(renderView, 300));

        // Filters
        document.getElementById('filter-status').addEventListener('change', renderView);
        document.getElementById('filter-assignee').addEventListener('change', renderView);
        document.getElementById('filter-priority').addEventListener('change', renderView);

        // Bulk actions
        document.getElementById('select-all').addEventListener('change', (e) => {
            if (e.target.checked) {
                lastRenderedLeadIds.forEach(id => selectedLeadIds.add(id));
            } else {
                lastRenderedLeadIds.forEach(id => selectedLeadIds.delete(id));
            }
            renderListView();
        });

        document.getElementById('bulk-apply-btn').addEventListener('click', applyBulkStatus);

        // Analytics toggle
        document.getElementById('toggle-analytics').addEventListener('click', () => {
            analyticsSection.classList.toggle('visible');
        });

        // Sidebar navigation
        document.querySelectorAll('.nav-item[data-filter]').forEach(item => {
            item.addEventListener('click', function() {
                const filter = this.dataset.filter;
                currentFilter = {};

                if (filter === 'my-leads') currentFilter.myLeads = true;
                else if (filter === 'urgent') currentFilter.tag = 'urgent';
                else if (filter === 'high-value') currentFilter.tag = 'high-value';
                else if (filter === 'follow-up') currentFilter.tag = 'follow-up';
                else if (filter === 'hot') currentFilter.tag = 'hot';

                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                this.classList.add('active');
                renderView();
            });
        });

        document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', function() {
                currentFilter = {};
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                this.classList.add('active');
                renderView();
            });
        });

        // Tag selection (prevent double toggle)
        const tagSelector = document.getElementById('tag-selector');
        if (tagSelector) {
            tagSelector.addEventListener('click', (e) => {
                const option = e.target.closest('.tag-option');
                if (!option) return;
                e.preventDefault();
                const checkbox = option.querySelector('input');
                checkbox.checked = !checkbox.checked;
                option.classList.toggle('selected', checkbox.checked);
            });
        }

        // Export
        document.getElementById('export-nav-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify(leads, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'cyberquell-crm-export.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully', 'success');
        });

        // Team modal
        document.getElementById('team-nav-btn').addEventListener('click', () => {
            renderTeamList();
            teamModal.classList.add('active');
        });

        document.getElementById('team-modal-close').addEventListener('click', () => {
            teamModal.classList.remove('active');
        });

        document.getElementById('team-close-btn').addEventListener('click', () => {
            teamModal.classList.remove('active');
        });

        teamModal.addEventListener('click', (e) => {
            if (e.target === teamModal) teamModal.classList.remove('active');
        });

        // Add team member
        document.getElementById('add-team-btn').addEventListener('click', async () => {
            if (!isManagerOrAdmin()) {
                showToast('Only managers or admins can add team members', 'error');
                return;
            }
            const name = document.getElementById('team-name').value.trim();
            const email = document.getElementById('team-email').value.trim();
            const role = document.getElementById('team-role').value;

            if (!name || !email) {
                showToast('Name and email are required', 'error');
                return;
            }

            try {
                await db.collection('users').add({
                    name,
                    email,
                    role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastSeen: null
                });
                document.getElementById('team-name').value = '';
                document.getElementById('team-email').value = '';
                document.getElementById('team-role').value = 'member';
                showToast('Team member added', 'success');
            } catch (error) {
                console.error('Add member error:', error);
                showToast('Failed to add member', 'error');
            }
        });

        function renderTeamList() {
            const list = document.getElementById('team-list');
            const canManage = isManagerOrAdmin();
            list.innerHTML = teamMembers.map(member => `
                <div class="team-member">
                    <img class="team-member-avatar" src="${member.photoURL || ''}" alt="${escapeHTML(member.name)}">
                    <div class="team-member-info">
                        <div class="team-member-name">${escapeHTML(member.name)}</div>
                        <div class="team-member-email">${escapeHTML(member.email)}</div>
                    </div>
                    ${canManage
                        ? `<div class="team-member-actions">
                                <select class="role-select" data-member-id="${member.id}">
                                    <option value="member" ${member.role === 'member' ? 'selected' : ''}>Member</option>
                                    <option value="manager" ${member.role === 'manager' ? 'selected' : ''}>Manager</option>
                                    <option value="admin" ${member.role === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                                ${member.id !== currentUser?.uid
                                    ? `<button type="button" class="btn btn-danger btn-small remove-member-btn" data-member-id="${member.id}">
                                            Remove
                                       </button>`
                                    : ''
                                }
                           </div>`
                        : `<span class="team-member-role">${escapeHTML(member.role || 'Member')}</span>`
                    }
                </div>
            `).join('');

            if (canManage) {
                list.querySelectorAll('.role-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const memberId = e.target.dataset.memberId;
                        const newRole = e.target.value;
                        try {
                            await db.collection('users').doc(memberId).update({ role: newRole });
                            showToast('Role updated', 'success');
                        } catch (error) {
                            console.error('Role update error:', error);
                            showToast('Failed to update role', 'error');
                        }
                    });
                });

                list.querySelectorAll('.remove-member-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const memberId = e.target.dataset.memberId;
                        if (memberId === currentUser?.uid) {
                            showToast('You cannot remove yourself', 'error');
                            return;
                        }
                        if (!confirm('Remove this team member?')) return;
                        try {
                            await db.collection('users').doc(memberId).delete();
                            showToast('Team member removed', 'success');
                        } catch (error) {
                            console.error('Remove member error:', error);
                            showToast('Failed to remove member', 'error');
                        }
                    });
                });
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLeadModal();
                teamModal.classList.remove('active');
            }
            if (e.key === 'n' && e.ctrlKey && currentUser) {
                e.preventDefault();
                openLeadModal();
            }
        });

        // =====================================
        // Mobile Sidebar Toggle
        // =====================================
        function closeMobileSidebar() {
            document.querySelector('.sidebar').classList.remove('open');
            document.getElementById('sidebar-backdrop').classList.remove('visible');
        }

        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('open');
            document.getElementById('sidebar-backdrop').classList.toggle('visible');
        });

        document.getElementById('sidebar-backdrop').addEventListener('click', closeMobileSidebar);

        // Close sidebar on nav item click (mobile)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 480) closeMobileSidebar();
            });
        });
    </script>
</body>
</html>
